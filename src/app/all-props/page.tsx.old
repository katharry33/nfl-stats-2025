'use client';

import React, { useState, useEffect, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { useBetSlip } from '@/context/betslip-context';
import { X, ArrowRight, Search, RotateCcw, Save, CheckCircle2 } from 'lucide-react';
import { toast } from 'sonner';

/**
 * SUB-COMPONENT: Individual Prop Card
 * This manages its own input state for "Total Odds" and handles the save request.
 */
function PropItem({ prop, addLeg }: { prop: any, addLeg: any }) {
  // Use the existing TotalOdds from DB if it exists, otherwise empty
  const [totalOdds, setTotalOdds] = useState(prop.TotalOdds || "");
  const [isSaving, setIsSaving] = useState(false);
  const [hasSaved, setHasSaved] = useState(false);

  const handleSaveOdds = async () => {
    setIsSaving(true);
    try {
      const res = await fetch('/api/all-props/update-odds', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: prop.id, totalOdds }),
      });
      
      if (res.ok) {
        setHasSaved(true);
        toast.success(`Updated odds for ${prop.Player}`);
        // Reset the success icon after 2 seconds
        setTimeout(() => setHasSaved(false), 2000);
      }
    } catch (e) {
      toast.error("Failed to save odds to database");
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <Card className="bg-slate-900 border-slate-800 hover:border-emerald-500/50 transition-colors group">
      <CardContent className="p-5">
        <div className="flex justify-between items-start mb-4">
          <div>
            <Badge className="mb-2 bg-emerald-500/10 text-emerald-500 border-none rounded-sm">WEEK {prop.Week}</Badge>
            <h3 className="font-bold text-white text-xl leading-none">{prop.Player || prop.player}</h3>
            <p className="text-slate-500 text-xs mt-1 font-bold">{prop.Team || prop.team} â€¢ {prop.Matchup}</p>
          </div>
        </div>
        
        <div className="bg-slate-950 rounded-lg p-4 border border-slate-800 group-hover:border-slate-700 transition-colors mb-4">
          <p className="text-[10px] uppercase font-black text-slate-500 mb-1">{prop.Prop || prop.prop}</p>
          <div className="flex items-baseline justify-between">
            <span className="text-3xl font-black text-white">{prop.Line || prop.line}</span>
            {/* Show updated odds or default to -110 if empty */}
            <span className="text-emerald-500 font-bold text-sm">
              {totalOdds || "-110"}
            </span>
          </div>
        </div>

        {/* MANUAL ODDS INPUT */}
        <div className="flex gap-2 mb-4">
          <Input 
            value={totalOdds}
            onChange={(e) => setTotalOdds(e.target.value)}
            placeholder="Set Odds (e.g. -115)"
            className="bg-slate-950 border-slate-800 h-9 text-xs"
          />
          <Button 
            size="sm" 
            variant="outline"
            onClick={handleSaveOdds}
            disabled={isSaving}
            className="border-slate-800 hover:bg-emerald-600 hover:text-white transition-all"
          >
            {hasSaved ? <CheckCircle2 className="h-4 w-4 text-emerald-400" /> : isSaving ? "..." : <Save className="h-4 w-4" />}
          </Button>
        </div>

        <Button 
          onClick={() => {
            addLeg({
              id: crypto.randomUUID(),
              propId: prop.id,
              player: prop.Player || prop.player,
              prop: prop.Prop || prop.prop,
              line: prop.Line || prop.line,
              selection: 'Over',
              odds: totalOdds || -110,
              source: 'all-props'
            });
            toast.success(`Added ${prop.Player} to slip`);
          }}
          className="w-full bg-white text-black hover:bg-emerald-500 hover:text-white font-black transition-all"
        >
          ADD TO SLIP
        </Button>
      </CardContent>
    </Card>
  );
}

export default function AllPropsPage() {
  const router = useRouter();
  const { legs: selections, addLeg, removeLeg, clearSelections } = useBetSlip();

  const [props, setProps] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);
  const [filterOptions, setFilterOptions] = useState<{
    weeks: number[],
    props: string[],
    teams: string[]
  }>({ weeks: [], props: [], teams: [] });

  const [filters, setFilters] = useState({
    season: '2025-2026',
    week: 'all',
    team: '',
    player: '',
    propType: 'all',
    gameDate: ''
  });

  // Fetch metadata/options
  useEffect(() => {
    const fetchMetadata = async () => {
      try {
        const res = await fetch('/api/all-props/options');
        const data = await res.json();
        setFilterOptions({
          weeks: data.weeks || [],
          props: data.props || [],
          teams: data.teams || []
        });
      } catch (e) { console.error(e); }
    };
    fetchMetadata();
  }, []);

  // Search logic
  const handleSearch = useCallback(async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      if (filters.week !== 'all') params.append('week', filters.week);
      if (filters.team) params.append('team', filters.team.toUpperCase().trim());
      if (filters.player) params.append('player', filters.player.trim());
      if (filters.propType !== 'all') params.append('prop', filters.propType);

      const response = await fetch(`/api/all-props?${params.toString()}`);
      const data = await response.json();
      setProps(Array.isArray(data) ? data : []);
    } catch (error) {
      toast.error("Failed to fetch props");
    } finally {
      setLoading(false);
    }
  }, [filters]);

  useEffect(() => { handleSearch(); }, [handleSearch]);

  return (
    <div className="p-6 max-w-[1800px] mx-auto">
      {/* ... Header and Filter Bar UI (Keep your existing JSX here) ... */}
      
      {/* Grid Display */}
      <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <div className="lg:col-span-3">
          {loading ? (
             <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-pulse">
               {[1,2,3,4].map(i => <div key={i} className="h-64 rounded-xl bg-slate-900 border border-slate-800" />)}
             </div>
          ) : props.length === 0 ? (
            <div className="flex flex-col items-center justify-center py-20 border-2 border-dashed border-slate-800 rounded-2xl">
              <Search className="h-10 w-10 text-slate-700 mb-4" />
              <p className="text-slate-500 font-medium">No results found for your criteria</p>
            </div>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
              {props.map((prop) => (
                <PropItem key={prop.id} prop={prop} addLeg={addLeg} />
              ))}
            </div>
          )}
        </div>

        {/* Bet Slip Sidebar (Keep your existing sidebar JSX here) */}
      </div>
    </div>
  );
}