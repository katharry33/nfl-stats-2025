'use client';

import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import {
  Loader2, AlertCircle, RefreshCw, ChevronDown, ChevronRight, ChevronUp,
    Layers, Minus, Trash2, Pencil, CheckSquare, Square, X, Search,
    } from 'lucide-react';
    import { Bet, BetLeg } from '@/lib/types';
    import { EditBetModal } from "@/components/bets/edit-bet-modal";
    import BettingStats from "@/components/bets/betting-stats";
    
    // ─── Helpers ──────────────────────────────────────────────────────────────────
    
    const calculateParlayStatus = (legs: BetLeg[]) => {
      // 1. If any leg is "lost", the whole parlay is "lost"
        if (legs.some(leg => leg.status === 'lost')) return 'lost';
        
          // 2. If all legs are "won" (or a mix of "won" and "void"), the parlay is "won"
            // We filter out "void" because they don't break the parlay
              const nonVoidLegs = legs.filter(leg => leg.status !== 'void');
                if (nonVoidLegs.length > 0 && nonVoidLegs.every(leg => leg.status === 'won')) {
                    return 'won';
                      }
                      
                        // 3. Otherwise, it's still "pending"
                          return 'pending';
                          };
                          
                          function fmtLine(n: any): string {
                            if (n == null || n === '') return '—';
                              const num = typeof n === 'number' ? n : parseFloat(String(n));
                                return isNaN(num) ? '—' : num.toFixed(1);
                                }
                                
                                function fmtDate(raw: string | null | undefined): string {
                                  if (!raw) return '—';
                                    try {
                                        const d = new Date(raw);
                                            return isNaN(d.getTime()) ? '—'
                                                  : d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
                                                    } catch { return '—'; }
                                                    }
                                                    
                                                    function fmtMoney(n: number | null | undefined): string {
                                                      if (!n) return '—';
                                                        return `$${Number(n).toFixed(2)}`;
                                                        }
                                                        
                                                        function PayoutCell({ payout, status, stake }: {
                                                          payout: number | null; status: string; stake: number | null;
                                                          }) {
                                                            const s = status.toLowerCase();
                                                              if (!payout) return <span className="text-slate-700">—</span>;
                                                                if (s === 'won' || s === 'win' || s === 'cashed')
                                                                    return <span className="text-emerald-400 font-mono font-bold">{fmtMoney(payout)}</span>;
                                                                      if (s === 'lost' || s === 'loss')
                                                                          return <span className="text-red-400 font-mono">{stake ? `-${fmtMoney(stake)}` : '—'}</span>;
                                                                            return (
                                                                                <span className="text-slate-500 font-mono text-xs">
                                                                                      {fmtMoney(payout)}{' '}
                                                                                            <span className="text-slate-700 text-[9px] uppercase">pot.</span>
                                                                                                </span>
                                                                                                  );
                                                                                                  }
                                                                                                  
                                                                                                  // ─── StatusBadge ─────────────────────────────────────────────────────────────
                                                                                                  
                                                                                                  function StatusBadge({ status, onClick }: { status?: string; onClick?: () => void }) {
                                                                                                    const s = (status ?? '').toLowerCase();
                                                                                                      const cls =
                                                                                                          s === 'won'  || s === 'win'    ? 'bg-emerald-500/15 text-emerald-400 border-emerald-500/25' :
                                                                                                              s === 'lost' || s === 'loss'   ? 'bg-red-500/15 text-red-400 border-red-500/25' :
                                                                                                                  s === 'void' || s === 'push'   ? 'bg-slate-700/20 text-slate-500 border-slate-700/20' :
                                                                                                                      s === 'cashed'                 ? 'bg-blue-500/15 text-blue-400 border-blue-500/25' :
                                                                                                                                                           'bg-amber-500/10 text-amber-400 border-amber-500/20';
                                                                                                                                                             return (
                                                                                                                                                                 <button onClick={onClick} disabled={!onClick} className={`inline-flex px-2 py-0.5 rounded text-[10px] font-bold uppercase border ${cls} ${onClick ? 'cursor-pointer' : ''}`}>
                                                                                                                                                                       {status ?? 'pending'}
                                                                                                                                                                           </button>
                                                                                                                                                                             );
                                                                                                                                                                             }
                                                                                                                                                                             
                                                                                                                                                                             // ─── Sortable header ──────────────────────────────────────────────────────────
                                                                                                                                                                             
                                                                                                                                                                             type SortDir = 'asc' | 'desc';
                                                                                                                                                                             
                                                                                                                                                                             function Th({ col, label, sortCol, sortDir, onSort, className = '' }: {
                                                                                                                                                                               col: string; label: string; sortCol: string; sortDir: SortDir;
                                                                                                                                                                                 onSort: (col: string) => void; className?: string;
                                                                                                                                                                                 }) {
                                                                                                                                                                                   const active = sortCol === col;
                                                                                                                                                                                     return (
                                                                                                                                                                                         <th
                                                                                                                                                                                               onClick={() => onSort(col)}
                                                                                                                                                                                                     className={`px-4 py-3 text-left text-[10px] font-bold text-slate-500 uppercase tracking-widest
                                                                                                                                                                                                             cursor-pointer select-none hover:text-slate-300 transition-colors ${className}`}
                                                                                                                                                                                                                 >
                                                                                                                                                                                                                       <span className="inline-flex items-center gap-1">
                                                                                                                                                                                                                               {label}
                                                                                                                                                                                                                                       {active
                                                                                                                                                                                                                                                 ? sortDir === 'asc'
                                                                                                                                                                                                                                                             ? <ChevronUp className="h-3 w-3 text-emerald-400" />
                                                                                                                                                                                                                                                                         : <ChevronDown className="h-3 w-3 text-emerald-400" />
                                                                                                                                                                                                                                                                                   : <ChevronDown className="h-3 w-3 text-slate-700" />
                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                 </span>
                                                                                                                                                                                                                                                                                                     </th>
                                                                                                                                                                                                                                                                                                       );
                                                                                                                                                                                                                                                                                                       }
                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                       // ─── CheckCell ───────────────────────────────────────────────────────────────
                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                       function CheckCell({ id, selected, onToggle }: {
                                                                                                                                                                                                                                                                                                         id: string; selected: boolean; onToggle: (id: string) => void;
                                                                                                                                                                                                                                                                                                         }) {
                                                                                                                                                                                                                                                                                                           return (
                                                                                                                                                                                                                                                                                                               <td className="px-3 py-3 text-center w-10" onClick={e => e.stopPropagation()}>
                                                                                                                                                                                                                                                                                                                     <button onClick={() => onToggle(id)} className="text-slate-500 hover:text-emerald-400">
                                                                                                                                                                                                                                                                                                                             {selected
                                                                                                                                                                                                                                                                                                                                       ? <CheckSquare className="h-4 w-4 text-emerald-400" />
                                                                                                                                                                                                                                                                                                                                                 : <Square className="h-4 w-4" />}
                                                                                                                                                                                                                                                                                                                                                       </button>
                                                                                                                                                                                                                                                                                                                                                           </td>
                                                                                                                                                                                                                                                                                                                                                             );
                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                             // ─── ParlayRow ────────────────────────────────────────────────────────────────
                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                             function ParlayRow({ bet, selected, onToggle, onEdit, onDelete, onToggleLegStatus }: {
                                                                                                                                                                                                                                                                                                                                                               bet: any; selected: boolean;
                                                                                                                                                                                                                                                                                                                                                                 onToggle: (id: string) => void;
                                                                                                                                                                                                                                                                                                                                                                   onEdit: (b: any) => void;
                                                                                                                                                                                                                                                                                                                                                                     onDelete: (id: string) => void;
                                                                                                                                                                                                                                                                                                                                                                       onToggleLegStatus: (betId: string, legIndex: number, currentStatus: string) => void;
                                                                                                                                                                                                                                                                                                                                                                       }) {
                                                                                                                                                                                                                                                                                                                                                                         const [open, setOpen] = useState(false);
                                                                                                                                                                                                                                                                                                                                                                           const canExpand = !bet.legsEmpty && bet.legs.length > 0;
                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                             return (
                                                                                                                                                                                                                                                                                                                                                                                 <>
                                                                                                                                                                                                                                                                                                                                                                                       <tr
                                                                                                                                                                                                                                                                                                                                                                                               onClick={() => canExpand && setOpen(o => !o)}
                                                                                                                                                                                                                                                                                                                                                                                                       className={`border-b border-slate-800/60 transition-colors group
                                                                                                                                                                                                                                                                                                                                                                                                                 ${selected ? 'bg-emerald-950/20' : 'hover:bg-slate-800/20'}
                                                                                                                                                                                                                                                                                                                                                                                                                           ${canExpand ? 'cursor-pointer' : 'opacity-60'}`}
                                                                                                                                                                                                                                                                                                                                                                                                                                 >
                                                                                                                                                                                                                                                                                                                                                                                                                                         <CheckCell id={bet.id} selected={selected} onToggle={onToggle} />
                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                 {/* Expand toggle */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                         <td className="w-8 px-2 py-3 text-center">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                   {!canExpand
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ? <Minus className="h-3.5 w-3.5 text-slate-700 mx-auto" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           : open
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ? <ChevronDown className="h-4 w-4 text-slate-400 mx-auto" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       : <ChevronRight className="h-4 w-4 text-slate-500 mx-auto" />}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {/* Player / Parlay */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <td className="px-4 py-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <div className="flex items-center gap-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <Layers className="h-3.5 w-3.5 text-indigo-400 shrink-0" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <div className="font-bold text-slate-100 text-sm">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               {bet.legsEmpty ? 'Parlay (no legs)' : `${bet.legs.length}-Leg Parlay`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           {canExpand && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <div className="text-[10px] text-slate-500 mt-0.5 truncate max-w-[220px]">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             {bet.legs.map((l: any) => l.player || '?').join(' · ')}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 {/* Week */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <td className="px-4 py-3 text-xs font-mono text-slate-400">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   {bet.week ? `WK ${bet.week}` : <span className="text-slate-700">—</span>}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   {/* Game Date */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <td className="px-4 py-3 text-xs text-slate-400">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     {fmtDate(bet.gameDate ?? bet.legs[0]?.gameDate ?? bet.createdAt)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     {/* Selection (summary) */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <td className="px-4 py-3 text-xs text-slate-500">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {canExpand ? `${bet.legs.length} legs` : '—'}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {/* Stake */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <td className="px-4 py-3 text-sm font-mono text-slate-300">{fmtMoney(bet.stake)}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {/* Payout */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <td className="px-4 py-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <PayoutCell payout={bet.payout} status={bet.status} stake={bet.stake} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         {/* Status */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <td className="px-4 py-3"><StatusBadge status={bet.status} /></td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         {/* Actions */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <td className="px-4 py-3 text-right">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <div className="flex items-center justify-end gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     onClick={e => { e.stopPropagation(); onEdit(bet); }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   className="p-1.5 text-slate-500 hover:text-white rounded" title="Edit"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <Pencil className="h-3.5 w-3.5" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   onClick={e => { e.stopPropagation(); onDelete(bet.id); }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 className="p-1.5 text-slate-500 hover:text-rose-400 rounded" title="Delete"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <Trash2 className="h-3.5 w-3.5" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     {/* Expanded leg rows */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           {open && bet.legs.map((leg: any, i: number) => (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   <tr key={leg.id ?? i} className="bg-slate-950/60 border-b border-slate-800/30">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <td colSpan={2} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {/* Player + Prop */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <td className="px-4 py-2 pl-10">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <div className="flex items-center gap-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           <span className="text-[9px] bg-indigo-900/40 text-indigo-300 border border-indigo-700/40 px-1.5 py-0.5 rounded font-bold">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           LEG {i + 1}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <div className="text-sm text-slate-200 font-medium">{leg.player || '—'}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <div className="text-[10px] text-slate-500 capitalize">{leg.prop || '—'}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     {/* Week */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <td className="px-4 py-2 text-xs font-mono text-slate-600">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           {leg.week ? `WK ${leg.week}` : '—'}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               {/* Game date */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <td className="px-4 py-2 text-xs text-slate-600">{fmtDate(leg.gameDate)}</td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   {/* Selection */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <td className="px-4 py-2 text-xs">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <span className={leg.selection?.toLowerCase() === 'over' ? 'text-blue-400 font-bold' : 'text-orange-400 font-bold'}>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       {leg.selection || '—'}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <span className="text-slate-400 font-mono ml-1">{fmtLine(leg.line)}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   {/* Leg Status */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <td className="px-4 py-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <StatusBadge status={leg.status} onClick={() => onToggleLegStatus(bet.id, i, leg.status)} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             <td colSpan={2} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       <td />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </tr>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ))}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
// ─── SingleRow ────────────────────────────────────────────────────────────────

function SingleRow({ bet, selected, onToggle, onEdit, onDelete }: {
  bet: any; selected: boolean;
  onToggle: (id: string) => void;
  onEdit: (b: any) => void;
  onDelete: (id: string) => void;
  }) {
  const leg = bet.legs?.[0] ?? {};

  return (
    <tr 
      className={`border-b border-white/5 hover:bg-white/[0.02] transition-colors group ${
        selected ? 'bg-primary/5' : ''
      }`}
    >
      <CheckCell id={bet.id} selected={selected} onToggle={onToggle} />
      <td className="w-8 px-2 py-3" />
      {/* ... rest of your row ... */}
    </tr>
  );
}
